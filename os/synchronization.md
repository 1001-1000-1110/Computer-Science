## 동기화란

- 실행 순서 제어 : 동시에 실행되는 프로세스를 올바른 순서대로 실행하는 것
    - Writer and Reader
        
        Writer와 Reader는 무작정 아무 순서대로 실행되어서는 안된다. Reader프로세스는 Writer프로세스 실행이 끝나야 실행될 수 있기 때문이다.
        
- 상호 배제 : 동시에 접근해서는 안되는 자원에 하나의 프로세스만 접근하는 것 → 자원의 일관성
    - Balance
        
        A와 B 프로세스가 ‘잔액’이라는 데이터에 동시에 접근해서는 안된다.
        
    - Producer and Consumer
        
        ```java
        총합 = 10
        
        생산자 () {
        	총합++;
        }
        
        소비자 () {
        	총합--;
        }
        ```
        
        생산자와 소비자를 각각 100번 동시에 실행한 경우, 동기화되지 않으면 엉뚱한 결과가 발생한다. 생상자와 소비자가 ‘총합’이라는 데이터에 동시에 접근했기 때문이다.
        
    
    ### 공유자원과 임계구역
    
    공유자원 : 여러 프로세스가 공유하는 자원 (전역변수, 파일, 입출력장치, 보조기억장치)
    
    공유자원 중 두 개 이상의 프로세스가 동시에 접근하면 안되는 자원이 있음. ex) 잔액, 총합
    
    임계구역 : 여러 프로세스가 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역
    
    → 상호 배제를 위한 동기화는 두 개 이상의 프로세스가 임계구역에 동시에 접근하지 못하도록 관리하는 것
    
    > **Race condition**
    > 
    > 
    > 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생한 경우
    > 
    > 발생 원인 : 보통 고급언어는 일반적으로 여러줄의 저급 언어로 변환되어 실행되는데, 컴퓨터는 이 여러줄의 저급 언어를 실행하기 때문에 여러 줄의 저급 언어로 변환된 고급 언어 한 줄을 실행하는 과정에서 문맥 교환이 일어날 수 있기 때문이다.
    > 
    
    ### 상호 배제를 위한 동기화를 위한 세가지 원칙
    
    1. 상호배제 : 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
    2. 진행 : 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야한다..
    3. 유한대기 : 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야한다.

## 동기화 기법

### 뮤텍스락, Mutex lock(상호배제)

한 프로세스가 임계구역에 진입했다면 임계구역을 lock해두는 것

- lock : 자물쇠 역할
    
    잠겨져 있다면 true, 열려있다면 false
    
    ```java
    lock = false;
    ```
    
- acquire : 임계구역을 잠그는 역할
    
    프로세스가 입계 구역에 진입하기 전에 호출하는 함수. 임계 구역이 잠겨 있다면 임계 구역이 열릴 때까지 반복적으로 확인하고 임계구역이 열렸다면 임계구역을 잠근다. → **busy waiting**
    
    ```java
    acquire() {
    	while (lock == true)
    		;
    	lock = true;
    }
    ```
    
    > **Busy wait**
    > 
    > 
    > lock이 false가 될 때까지 lock을 반복적으로 확인하는 대기방식
    > 
- release : 임계구역의 잠금을 해제하는 역할
    
    임계구역에서 작업이 끝나고 호출하는 함수. 잠김 임계구역을 연다.
    
    ```java
    release() {
    	lock = false;
    }
    ```
    

acquire와 release함수를 임계구역 전후로 호출하여 하나의 프로세스만 임계구역에 진입할 수 있도록한다.

```java
acquire();
// 임계 구역
release();
```

### 세마포, semaphore (상호배제, 실행순서)

1. 세마포 (상호배제)
    
    뮤텍스락은 하나의 공유자원에 접근하는 프로세스를 상정한 방식이지만 세마포는 공유자원이 여러개 있는 상황에서도 적용이 가능한 동기화도구
    
    - S : 사용 가능한 공유 자원의 개수
        
        ```java
        S = 공유자원개수
        ```
        
    - wait : 임계구역진입이 가능한 지, 기다려야하는 지 알려주는 함수
        
        사용 가능한 공유 자원이 생길 때까지 반복적으로 확인하다가 공유자원이 생기면 내가 사용 → **busy wating**
        
        ```java
        wait() {
        	while (S <= 0)
        		;
        	S--;
        }
        ```
        
    - signal : 대기중엔 프로세스에게 임계구역에 진입해도 좋다는 신호를 주는 함수
        
        사용한 자원을 반납
        
        ```java
        signal() {
        	S++;
        }
        ```
        
    
    세마포도 뮤텍스락과 마찬가지로 임계구역 전후로 wait()와 signal()을 호출한다.
    
    ```java
    wait()
    // 임계구역
    signal()
    ```
    
    ex) 프로세스 P1, P2, P3가 두개의 공유자원(S=2)에 P1, P2, P3순서로 접근한다면
    
    1. P1 wait : S 2 → 1, P1 진입
    2. P2 wait : S 1 → 0, P2진입
    3. P3 wait : S == 0, P3대기
    4. P1 signal : S 0 → 1
    5. S 1 → 0 P3진입
    6. P2 signal : S 0 → 1
    7. P3 signal : S 1 → 2
    
    busy waiting을 할 경우, 프로세스는 무작정 반복하여 S를 확인해야한다. → CPU주기 낭비
    
2. 세마포 with Q (상호배제)
    - S : 사용가능한 공유자원의 개수, 음수일 경우 절대값은 대기 중인 프로세스 개수
    - wait
        
        S-1한 값이 음수일 경우 대기중인 프로세스가 존재한다는 것 → 대기 큐로 이동
        
        ```java
        wait() {
        	S--;
        	if (S < 0) {
        		add this process to Queue;
        		sleep();
        	}
        }
        ```
        
    - signal
        
        S+1한 값이 0보다 같거나 작을 경우 대기중인 프로세스가 존재한다는 것 → 대기 큐에 있는 프로세스를 준비상태로 만듬.
        
        ```java
        signal() {
        	S++
        	if (S <= 0) {
        		remove a process p from Queue;
        		wakeup(p);
        	}
        }
        ```
        
        ex) 프로세스 P1, P2, P3가 두개의 공유자원(S=2)에 P1, P2, P3순서로 접근한다면
        
        1. P1 wait : S 2 → 1, P1 진입
        2. P2 wait : S 1 → 0, P2진입
        3. P3 wait : S 0 → -1, P3대기
        4. P1 signal : S -1 → 0, P3 대기큐에서 pop
        5. P3진입
        6. P2 signal : S 0 → 1
        7. P3 signal : S 1 → 2
3. 세마포 with Q (실행순서)
    
    세마포의 변수 S를 0으로 두고 먼저 실행할 프로세스 뒤에 signal함수, 다음에 실행할 프로세스 앞에 wait함수를 붙임
    
    ex) P1다음에 P2이 실행되어야하는 경우
    
    - P1이 먼저 실행할 경우
        1. P1 진입
        2. P2 wait : S 0 → -1, P2대기
        3. P1 signal : S -1 → 0, P2 대기큐에서 pop
        4. P2진입
    - P2이 먼저 실행할 경우
        1. P2 wait : S 0 → -1, P2대기
        2. P1 진입
        3. P1 signal : S -1 → 0, P2 대기큐에서 pop
        4. P2진입
    
    → P1가 먼저 실행되는 P2가 먼저 실행되든 반드시 P1, P2순으로 진입
    

### 모니터 (상호배제, 실행순서)

임계구역 앞 뒤로 일일이 wait와 signal함수를 호출해야하는 세마포에 비해 사용자가 사용하기에 훨씬 편리한 도구이다.

- 상호배제
    
    - 모니터는 공유자원과 공유 자원에 접근하기 위한 인터페이스를 묶어 관리
        
        프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근
        
    - 공유자원에 접근하고자하는 프로세스를 큐에 삽입하고 큐에 삽입된 순서대로 하나씩 공유 자원을 이용
        
        모니터 안에 항상 하나의 프로세스만 진입하도록 하여 상호배제를 위한 동기화를 제공
        
- 실행순서
    1. 특정 프로세스가 아직 실행될 조건이 되지 않았을 때는 wait을 통해 실행을 중단
    2. 특정 프로세스가 실행될 조건이 충족되었을 때는 signal을 통해 실행을 재개
    
    - 조건변수 : 프로세스나 프레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수로, 조건변수마다 큐가 존재
    - 조건변수로 wait와 signal연산을 수행할 수 있다.
        
        x.wait : 해당 프로세스의 상태를 대기상태로 전환하고 x에 대한 대기 큐에 삽입 → 다른 프로세스의 x.signal을 통해 실행이 재개될 수 있다.
        
        x. signal : x에 대한 대기큐를 pop하여 대기중인 프로세스의 실행을 재개 → wait를 호출하여 큐에 삽입된 프로세스의 실행을 재개하는 연산
        
        → 모니터 안에는 하나의 프로세스만 진입할 수 있으므로, wait를 호출했던 프로세스는 signal을 호출한 프로세스가 모니터를 떠난 뒤에 실행되거나 signal을 호출한 프로세스의 실행일 일시 중단하고 자신이 실행된 뒤 다시 signal을 호출하나 프로세스의 수해을 재개한다.
